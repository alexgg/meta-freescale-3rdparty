From 80d92b22ccf3e704673f1dce24b59c89c48c42fa Mon Sep 17 00:00:00 2001
From: Alex Gonzalez <alex.gonzalez@digi.com>
Date: Fri, 20 Apr 2018 19:13:02 +0200
Subject: [PATCH 01/11] ARM: Add support for the ConnectCore 6UL
 System-On-Module

Signed-off-by: Alex Gonzalez <alex.gonzalez@digi.com>
---
 arch/arm/mach-imx/Kconfig        |  8 +++++
 arch/arm/mach-imx/Makefile       |  2 +-
 arch/arm/mach-imx/som-ccimx6ul.c | 69 ++++++++++++++++++++++++++++++++++++++++
 3 files changed, 78 insertions(+), 1 deletion(-)
 create mode 100644 arch/arm/mach-imx/som-ccimx6ul.c

diff --git a/arch/arm/mach-imx/Kconfig b/arch/arm/mach-imx/Kconfig
index b2e4030dedd2..36bc06eda2a2 100644
--- a/arch/arm/mach-imx/Kconfig
+++ b/arch/arm/mach-imx/Kconfig
@@ -523,6 +523,14 @@ config SOC_IMX6UL
 	help
 	  This enables support for Freescale i.MX6 UltraLite processor.
 
+config SOM_CC6UL
+	bool "Digi ConnectCore 6UL System-On-Module support"
+	select SOC_IMX6UL
+	select SOC_IMX6
+
+	help
+	  This enables support for Digi ConnectCore 6UL System-On-Module.
+
 config SOC_LS1021A
 	bool "Freescale LS1021A support"
 	select ARM_GIC
diff --git a/arch/arm/mach-imx/Makefile b/arch/arm/mach-imx/Makefile
index 0b9312651e0a..a435716b8331 100644
--- a/arch/arm/mach-imx/Makefile
+++ b/arch/arm/mach-imx/Makefile
@@ -86,7 +86,7 @@ obj-$(CONFIG_SOC_IMX6UL) += mach-imx6ul.o
 obj-$(CONFIG_SOC_IMX7D_CA7) += mach-imx7d.o
 obj-$(CONFIG_SOC_IMX7D_CM4) += mach-imx7d-cm4.o
 obj-$(CONFIG_SOC_IMX7ULP) += mach-imx7ulp.o pm-imx7ulp.o
-
+obj-$(CONFIG_SOM_CC6UL) += som-ccimx6ul.o
 ifeq ($(CONFIG_SUSPEND),y)
 AFLAGS_suspend-imx6.o :=-Wa,-march=armv7-a
 obj-$(CONFIG_SOC_IMX6) += suspend-imx6.o
diff --git a/arch/arm/mach-imx/som-ccimx6ul.c b/arch/arm/mach-imx/som-ccimx6ul.c
new file mode 100644
index 000000000000..269b526ee020
--- /dev/null
+++ b/arch/arm/mach-imx/som-ccimx6ul.c
@@ -0,0 +1,69 @@
+/*
+ *  Copyright 2018 Digi International Inc
+ *
+ *  This program is free software; you can redistribute  it and/or modify it
+ *  under  the terms of  the GNU General  Public License as published by the
+ *  Free Software Foundation;  either version 2 of the  License, or (at your
+ *  option) any later version.
+ */
+
+#include <linux/kernel.h>
+#include <linux/export.h>
+#include <linux/errno.h>
+#include <linux/of.h>
+#include <linux/string.h>
+
+static int digi_board_version = -EINVAL;
+
+int digi_get_board_version(void)
+{
+	struct device_node *np = NULL;
+	const char *boardver_str;
+	char buf[4];
+
+	/* Only need to read the carrier board once */
+	if (digi_board_version > 0)
+		return digi_board_version;
+
+	np = of_find_node_by_path("/");
+	if (!np)
+		return -EPERM;
+
+	if (!of_property_read_string(np, "digi,carrierboard,version",
+				&boardver_str)) {
+		strncpy(buf, boardver_str, sizeof(buf));
+		if (!kstrtoint(boardver_str, 10, &digi_board_version))
+			pr_debug("Board version: %d\n", digi_board_version);
+	}
+	of_node_put(np);
+
+	return digi_board_version;
+}
+EXPORT_SYMBOL(digi_get_board_version);
+
+static int digi_som_hv = -EINVAL;
+
+int digi_get_som_hv(void)
+{
+	struct device_node *np = NULL;
+	const char *som_hv_str;
+	char buf[4];
+
+	/* Only need to read the HV once */
+	if (digi_som_hv > 0)
+		return digi_som_hv;
+
+	np = of_find_node_by_path("/");
+	if (!np)
+		return -EPERM;
+
+	if (!of_property_read_string(np, "digi,hwid,hv", &som_hv_str)) {
+		strncpy(buf, som_hv_str, sizeof(buf));
+		if (!kstrtoint(som_hv_str, 16, &digi_som_hv))
+			pr_debug("SOM HV: %d\n", digi_som_hv);
+	}
+	of_node_put(np);
+
+	return digi_som_hv;
+}
+EXPORT_SYMBOL(digi_get_som_hv);
